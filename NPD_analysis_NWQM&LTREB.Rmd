---
title: "NPD analysis of FluxData_NWQM&LTREB"
author: "Marc Peipoch"
date: "7/23/2021"
output: html_document
---

This script uses data from the rawdata sheet in FluxData_NWQM&LTREB_27Oct2022

After importing the data and grouping events by week to avoid date mismatches among sites we'll do similar analyses to Valett et al first and also add efficiency metrics.

```{r setup, include=FALSE}
library(ggplot2); library(dplyr) ; library(lubridate) ; library(tidyverse) ; library(psych)
#upload the data
NPD_raw_data = read.table("clipboard", header = T, sep="\t")
NPD_raw_data = read.csv("FluxData_NWQM&LTREB_27Oct2022.csv")

NPD_raw_data$date = as.POSIXct(NPD_raw_data$date, format = "%m/%d/%Y") #format as date
NPD_raw_data = NPD_raw_data[1:1949,1:14]
  
  
    NPD_formated_data = NPD_raw_data %>%
      group_by(year)  %>%
      mutate(event_num = paste(year,agg_julian_day,sep="_")) 
    #create an event_num variable that categorize each sampling event


#now need to calculate efficiency removal for each reach, first transpose the data and calculate fluxes
nitrate_horizontal_data = NPD_formated_data %>% 
    mutate(nit_flux = nitrate * flow) %>%
    select(station,year,agg_julian_day,event_num,nit_flux) %>%
        pivot_wider(names_from = station, values_from = nit_flux,values_fn = list)

nitrate_horizontal_data = as.data.frame(nitrate_horizontal_data) #to remove the tibble format

#check there is one observation per event number 
if (length(unique(nitrate_horizontal_data$event_num)) == nrow(nitrate_horizontal_data)){ 
  print("good to go") } 

#Now calculate efficiency numbers per reach with geometric mean
#First make sure all fluxes are of numeric class
cols.num <- c("ws","dl","abf","gc","bo","tu")
nitrate_horizontal_data[cols.num] <- sapply(nitrate_horizontal_data[cols.num],as.character)
nitrate_horizontal_data[cols.num] <- sapply(nitrate_horizontal_data[cols.num],as.numeric)
sapply(nitrate_horizontal_data, class)


nitrate_eff = nitrate_horizontal_data %>%
  group_by(event_num) %>%
            mutate(., effE_nit_r1 = dl - ws / (exp(rowMeans(log(.[,c("dl","ws")]),na.rm=TRUE))),
                   effE_nit_r2 = abf - dl / (exp(rowMeans(log(.[,c("abf","dl")]),na.rm=TRUE))),
                   effE_nit_r3 = gc - abf / (exp(rowMeans(log(.[,c("gc","abf")]),na.rm=TRUE))),
                   effE_nit_r4 = bo - gc / (exp(rowMeans(log(.[,c("bo","gc")]),na.rm=TRUE))),
                   effE_nit_r5 = tu - bo / (exp(rowMeans(log(.[,c("tu","bo")]),na.rm=TRUE))),
                   effE_nit_r34 = bo - abf / (exp(rowMeans(log(.[,c("bo","abf")]),na.rm=TRUE))))

nitrate_eff_2 = nitrate_horizontal_data %>%
  group_by(event_num) %>%
            mutate(., geom_R1 = psych::geometric.mean(.[,c("dl","ws")],na.rm=TRUE))



psych::geometric.mean(nitrate_horizontal_data[1,c("dl","ws")],na.rm=TRUE)



```

